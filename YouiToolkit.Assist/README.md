# 1 概述

本通信协议用于小车车载控制器（以下简称：车载系统、Pilot）与小车建图工具（以下简称：维护工具、Toolkit、TK）的数据交互。

 

# 2 通信方式

本通信协议通信方式为网络通信（TCP/IP），Pilot为服务端，端口号为59488，MT为客户端。

 

# 3 数据包

| 标识符     |         | 3 bytes |
| ---------- | ------- | ------- |
| 数据长度 N | 1-65535 | 2 bytes |
| 长度校验码 |         | 2 bytes |
| 有效数据   |         | N bytes |
| 校验码     | CRC校验 | 2 bytes |

标识符为数据包的起始码，当收到此编码串后，可以开始接收数据包，本协议统一用“UIA”做标识符，即：0x55 0x49 0x41。数据长度为该数据包有效数据的长度，范围为1-65535。长度校验码为数据长度取反的值，如：当有效数据长度为43时，数据长度为：0x2B 0x00，长度校验码为：0xD4 0xFF。校验码为有效数据的CRC校验码。特别的，**本协议涉及的所有数据转换，全部都是低位在前高位在后**，如：整型1000转换成四位数组为：0xE8 0x03 0x00 0x00，整型5转换成二位数组为：0x05 0x00。

 

# 4 有效数据

有效数据分为命令码和命令值两部分，命令码用于区分命令的类型，命令值为该命令码的扩展参数。有效数据结构如下：

| 会话标识 | 2 bytes |
| -------- | ------- |
| 模块码   | 1 byte  |
| 命令码   | 1 byte  |
| 命令值   | M bytes |

有效数据分为三种类型，分别是：请求、响应和报告。请求用于发起一个会话，一般会对应一个响应。

会话标识用于区分会话，每次请求会随机产生会话标识，每次响应必须跟请求的会话标识一致。报告的会话标识为0x00。

 

# 5 模块码

| 模块         | 模块码 |
| ------------ | ------ |
| 建图节点模块 | 0x01   |
| 避障节点模块 | 0x02   |
| 维护节点模块 | 0x03   |



# 6 节点通信

## 6.1 建图节点通信

### 6.1.1 心跳

**请求**

模块码：0x01

命令码：0x01

命令值：

| 预留 | 0x00 0x00 | 2 byte |
| ---- | --------- | ------ |

 **响应**

模块码：0x01

命令码：0xA1

命令值：

| 预留 | 0x00 0x00 | 2 bytes |
| ---- | --------- | ------- |

###  6.1.2 位姿图列表

**请求**

模块码：0x01

命令码：0x12

命令值：

| 预留 | 0x00 0x00 | 2 bytes |
| ---- | --------- | ------- |

 **响应**

模块码：0x01

命令码：0xB2

命令值：

| 总包数   |                                                              | 1 byte       |
| -------- | ------------------------------------------------------------ | ------------ |
| 当前包   |                                                              | 1 byte       |
| 节点数量 | N                                                            | 2 bytes      |
| 节点数据 | N个节点，每个节点占18个bytes，其中：<br />编号，2 bytes，<br />int版本，4 bytes，<br />intX，4 bytes，<br />floatY，4 bytes，<br />floatYaw，4 bytes，float | 18 * N bytes |
| 预留     | 0x00 0x00                                                    | 2 bytes      |

### 6.1.3 位姿图

**请求**

模块码：0x01

命令码：0x13

命令值：

| 编号 | ushort    | 2 bytes |
| ---- | --------- | ------- |
| 预留 | 0x00 0x00 | 2 bytes |

**响应**

模块码：0x01 

命令码：0xB3

命令值：

| 编号   |                                                              | 2 bytes     |
| ------ | ------------------------------------------------------------ | ----------- |
| 版本   |                                                              | 4 bytes     |
| 总包数 |                                                              | 1 byte      |
| 当前包 |                                                              | 1 byte      |
| 点个数 | N                                                            | 2 bytes     |
| 数据   | N个点，每个点占8个bytes，其中：X，4 bytes，floatY，4 bytes，float | 8 * N bytes |
| 预留   | 0x00 0x00                                                    | 2 bytes     |

### 6.1.4 点云图

**请求**

模块码：0x01

命令码：0x24

命令值：

| 预留 | 0x00 0x00 | 2 bytes |
| ---- | --------- | ------- |

**响应**

模块码：0x01

命令码：0xC4

命令值：

| 位置X    | float                                                        | 4 bytes     |
| -------- | ------------------------------------------------------------ | ----------- |
| 位置Y    | float                                                        | 4 bytes     |
| 角度A    | float                                                        | 4 bytes     |
| 总包数   |                                                              | 1 byte      |
| 当前包   |                                                              | 1 byte      |
| 起始编号 |                                                              | 2 bytes     |
| 总点数   |                                                              | 2 bytes     |
| 当前点数 | N                                                            | 2 bytes     |
| 数据     | N个点，每个点占8个bytes，其中：X，4 bytes，floatY，4 bytes，float | 8 * N bytes |
| 预留     | 0x00 0x00                                                    | 2 bytes     |

### 6.1.5 先验点云图

**请求**

模块码：0x01 

命令码：0x25

命令值：

| 地图名称长度 | N         | 2 bytes |
| ------------ | --------- | ------- |
| 地图名称     |           | N bytes |
| 预留         | 0x00 0x00 | 2 bytes |

**响应**

模块码：0x01

命令码：0xC5

命令值：

| 总包数 |                                                              | 1 byte       |
| ------ | ------------------------------------------------------------ | ------------ |
| 当前包 |                                                              | 1 byte       |
| 数据   | 原点位置X，4 bytes，float（仅出现在0号包）<br />原点位置Y，4 bytes，float（仅出现在0号包）<br />角度A，4 bytes，float（仅出现在0号包）<br />分辨率R，4 bytes，float仅出现在0号包）<br />PNG数据总长度，4 bytes，uint仅出现在0号包）<br />PNG图片数据，N bytes | 16 + N bytes |
| 预留   | 0x00 0x00                                                    | 2 bytes      |

 

### 6.1.6 建图状态

**请求**

模块码：0x01 

命令码：0x31

命令值：

| 预留 | 0x00 0x00 | 2 bytes |
| ---- | --------- | ------- |

 **响应**

模块码：0x01

命令码：0xD1

命令值：

| 雷达数据   | 0：异常；1：正常                                             | 1 byte  |
| ---------- | ------------------------------------------------------------ | ------- |
| 建图状态   | 0：未知；<br />1：待命；<br />2：建图中；<br />3：保存地图中；<br />4：未加载地图；<br />5：已加载地图；<br />6：补建中；<br />7：取消中 | 1 byte  |
| 重定位状态 | 0：未知；<br />1：已重定位；<br />2：未重定位；<br />3：异常 | 1 byte  |
| 异常码     |                                                              | 2 bytes |
| 位置X      | float                                                        | 4 bytes |
| 位置Y      | float                                                        | 4 bytes |
| 角度A      | float                                                        | 4 bytes |
| 预留       | 0x00 0x00                                                    | 2 bytes |

### 6.1.7 地图名称

**请求**

模块码：0x01

命令码：0x32

命令值：

| 预留 | 0x00 0x00 | 2 bytes |
| ---- | --------- | ------- |

**响应**

模块码：0x01

命令码：0xD2

命令值：

| 地图名称长度 | N         | 2 bytes |
| ------------ | --------- | ------- |
| 地图名称     |           | N bytes |
| 预留         | 0x00 0x00 | 2 bytes |

 

### 6.1.8 地图列表

**请求**

模块码：0x01

命令码：0x33

命令值：

| 预留 | 0x00 0x00 | 2 bytes |
| ---- | --------- | ------- |

**响应**

模块码：0x01

命令码：0xD3

命令值：

| 地图列表长度 | N                  | 2 bytes |
| ------------ | ------------------ | ------- |
| 地图列表     | 以'\n'分隔的地图名 | N bytes |
| 预留         | 0x00 0x00          | 2 bytes |

 

### 6.1.9 建图控制

**请求**

模块码：0x01

命令码：0x91

命令值：

| 指令         | 0x01：开始建图（***需指定地图名称***）；<br />0x02：停止建图并保存地图；<br />0x03：取消建图（不保存地图）；<br />0x11：加载地图（***需指定地图名称***）；<br />0x12：删除地图（***需指定地图名称***）；<br />0x21：开始补建；<br />0x22：停止补建并保存地图；<br />0x23：取消补建（不保存地图）； | 1 byte  |
| ------------ | ------------------------------------------------------------ | ------- |
| 地图名称长度 | N                                                            | 2 bytes |
| 地图名称     |                                                              | N bytes |
| 预留         | 0x00 0x00                                                    | 2 bytes |

**响应**

模块码：0x01

命令码：0xE1

命令值：

| 结果   | 0x00：未知；<br />0x01：成功；<br />0x02：失败；             | 1 byte  |
| ------ | ------------------------------------------------------------ | ------- |
| 错误码 | 0x00：无；<br />0x01：状态错误；<br />0x02：地图名称不存在；<br />0x03：未加载地图；<br />0x04：无定位数据； | 1 byte  |
| 预留   | 0x00 0x00                                                    | 2 bytes |

 

### 6.1.10 重定位控制

**请求**

模块码：0x01 

命令码：0x92

命令值：

| 指令      | 0x01：自动重定位；<br />0x02：指定初始位姿； | 1 byte  |
| --------- | -------------------------------------------- | ------- |
| 初始位置X | float                                        | 4 bytes |
| 初始位置Y | float                                        | 4 bytes |
| 初始角度A | float                                        | 4 bytes |
| 预留      | 0x00 0x00                                    | 2 bytes |

**响应**

模块码：0x01

命令码：0xE2

命令值：

| 结果   | 0x00：未知；<br />0x01：成功；<br />0x02：失败； | 1 byte  |
| ------ | ------------------------------------------------ | ------- |
| 错误码 | 0x00：无；0x01：……（待定）                       | 1 byte  |
| 预留   | 0x00 0x00                                        | 2 bytes |

### 6.1.11 数据错误

**报告**

模块码：0x01

命令码：0xF0

命令值：

| 错误码 | 0x00：未知；<br />0x01：命令码错误；<br />0x02：长度错误；<br />0x03：命令值错误；<br />0x04：权限不足；<br />0x05：内存不足；<br />0x06：CRC校验失败；<br />0x07：回环成功； | 1 byte  |
| ------ | ------------------------------------------------------------ | ------- |
| 错误值 |                                                              | 4 bytes |
| 预留   | 0x00 0x00                                                    | 2 bytes |



## 6.2 避障节点通信

### 6.2.1 心跳

**请求**

模块码：0x02

命令码：0x01

命令值：

| 预留 | 0x00 0x00 | 2 byte |
| ---- | --------- | ------ |

**响应**

模块码：0x02

命令码：0xA1

命令值：

| 预留 | 0x00 0x00 | 2 bytes |
| ---- | --------- | ------- |

### 6.1.2 当前雷达点云数据

**请求**

模块码：0x02

命令码：0x02

命令值：

| 预留 | 0x00 0x00 | 2 bytes |
| ---- | --------- | ------- |

**响应**

模块码：0x02

命令码：0xA2

命令值：

| 总包数   |                                                              | 1 byte       |
| -------- | ------------------------------------------------------------ | ------------ |
| 当前包   |                                                              | 1 byte       |
| 起始编号 |                                                              | 2 bytes      |
| 总点数   |                                                              | 2 bytes      |
| 当前点数 | N                                                            | 2 bytes      |
| 数据     | N个点，每个点占10个bytes，其中：<br />floatX，4 bytes，<br />floatY，4 bytes，<br />intensity, 2 byte | 10 * N bytes |
| 预留     | 0x00 0x00                                                    | 2 bytes      |



### 6.1.3 避障区域文件上传

**请求**

模块码：0x02

命令码：0x03

命令值：

| 预留   | 0x00 0x00                                                    | 2 bytes     |
| ------ | ------------------------------------------------------------ | ----------- |
| 当前包 |                                                              | 1 byte      |
| 数据   | json数据总长度，4 bytes，uint (仅出现在0号包）<br />json数据，N bytes | 4 + N bytes |
| 预留   | 0x00 0x00                                                    | 2 bytes     |

**响应**

模块码：0x02

命令码：0xA3

命令值：

| 总包数 |                                                  | 1 byte  |
| ------ | ------------------------------------------------ | ------- |
| 结果   | 0x00：未知；<br />0x01：成功；<br />0x02：失败； | 1 byte  |
| 预留   | 0x00 0x00                                        | 2 bytes |



### 6.1.3 避障区域文件下载

**请求**

模块码：0x02

命令码：0x04

命令值：

| 预留 | 0x00 0x00 | 2 bytes |
| ---- | --------- | ------- |

**响应**

模块码：0x02

命令码：0xA4

命令值：

| 总包数 |                                                              | 1 byte      |
| ------ | ------------------------------------------------------------ | ----------- |
| 当前包 |                                                              | 1 byte      |
| 数据   | json数据总长度，4 bytes，uint (仅出现在0号包）<br />json数据，N bytes | 4 + N bytes |
| 预留   | 0x00 0x00                                                    | 2 bytes     |

Json文件示例：

`scan_obstacle_area_demo.json`

```json
{
   "area" : {
      "1" : {
         "decelerate" : [
            [ -3.1415926535897931, 2 ],
            [ -2.938909256584, 2 ],
            [ 3.1415926535897931, 2 ]
         ],
         "emergency_stop" : [
            [ -3.1415926535897931, 0.5 ],
            [ 2.938909256584, 0.5 ],
            [ 3.1415926535897931, 0.5 ]
         ],
         "stop" : [
            [ -3.1415926535897931, 1 ],
            [ 2.938909256584, 1 ],
            [ 3.1415926535897931, 1 ]
         ]
      },
      "2" : 
      {
         "decelerate" : [
            [ -3.1415926535897931, 2 ],
            [ 2.938909256584, 2 ],
            [ 3.1415926535897931, 2 ]
         ],
         "emergency_stop" : [
            [ -3.1415926535897931, 0.5 ],
            [ 2.938909256584, 0.5 ],
            [ 3.1415926535897931, 0.5 ]
         ],
         "stop" : [
            [ -3.1415926535897931, 1 ],
            [ 2.938909256584, 1 ],
            [ 3.1415926535897931, 1 ]
         ]
      }
   },
   "sensitivity" : 0.5,
   "delay_start" : 0,
   "delay_end" : 0
}
```

### 6.1.5 获取当前避障状态

**请求**

模块码：0x02

命令码：0x05

命令值：

| 预留 | 0x00 0x00 | 2 bytes |
| ---- | --------- | ------- |

**响应**

模块码：0x02

命令码：0xA5

命令值：

| 当前避障状态   | N<br />bit0：减速<br />bit1：停止<br />bit2：急停<br /> | 1 byte  |
| -------------- | ------------------------------------------------------- | ------- |
| 当前生效区域id | 1~16                                                    | 2 bytes |
| 预留           | 0x00 0x00                                               | 2 bytes |



### 6.1.6 避障区域仿真

**请求**

模块码：0x02

命令码：0x06

命令值：

| 设置生效区域id | 1~16      | 2 bytes |
| -------------- | --------- | ------- |
| 预留           | 0x00 0x00 | 2 bytes |

**响应**

模块码：0x02

命令码：0xA6

命令值：

| 结果 | 0x00：未知；<br />0x01：成功；<br />0x02：失败； | 1 byte  |
| ---- | ------------------------------------------------ | ------- |
| 预留 | 0x00 0x00                                        | 2 bytes |



### 6.2.7 数据错误

**报告**

模块码：0x02

命令码：0xF0

命令值：

| 错误码 | 0x00：未知；<br />0x01：命令码错误；<br />0x02：长度错误；<br />0x03：命令值错误；<br />0x04：权限不足；<br />0x05：内存不足；<br />0x06：CRC校验失败； | 1 byte  |
| ------ | ------------------------------------------------------------ | ------- |
| 错误值 |                                                              | 4 bytes |
| 预留   | 0x00 0x00                                                    | 2 bytes |



## 6.3 维护节点通信

### 6.3.1 心跳

**请求**

模块码：0x03

命令码：0x01

命令值：

| 预留 | 0x00 0x00 | 2 byte |
| ---- | --------- | ------ |

**响应**

模块码：0x03

命令码：0xA1

命令值：

| 预留 | 0x00 0x00 | 2 bytes |
| ---- | --------- | ------- |


### 6.3.2 导航实时数据

暂时直接使用6.1.4和6.1.5部分数据

### 6.3.3 导航文件目录

**请求**

模块码：0x03

命令码：0x03

命令值：

| 预留 | 0x00 0x00 | 2 byte |
| ---- | --------- | ------ |

**响应**

模块码：0x03

命令码：0xA3

命令值：

| 文件总个数 | --------- | 2 bytes |
| 当前文件序号 | N       | 2 bytes |
| 当前文件开始时间 | 2201242242 | 4 bytes |
| 当前文件结束时间 | 2201242245 | 4 bytes |
| 预留     | 0x00 0x00   | 2 bytes |

### 6.3.4 导航文件历史数据(参考6.1.4点云图)

**请求**

模块码：0x03

命令码：0x24

命令值：

| 预留 | 0x00 0x00 | 2 bytes |
| ---- | --------- | ------- |

**响应**

模块码：0x03

命令码：0xC4

命令值：

| 位置X    | float                                                        | 4 bytes     |
| -------- | ------------------------------------------------------------ | ----------- |
| 位置Y    | float                                                        | 4 bytes     |
| 角度A    | float                                                        | 4 bytes     |
| 总包数   |                                                              | 1 byte      |
| 当前包   |                                                              | 1 byte      |
| 起始编号 |                                                              | 2 bytes     |
| 总点数   |                                                              | 2 bytes     |
| 当前点数 | N                                                            | 2 bytes     |
| 数据     | N个点，每个点占8个bytes，其中：X，4 bytes，floatY，4 bytes，float | 8 * N bytes |
| 预留     | 0x00 0x00                                                    | 2 bytes     |

### 6.3.5 报表数据-速度






